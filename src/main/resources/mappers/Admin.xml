<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
    <mapper namespace="com.camping.bit.dao.AdminDao">

    <select id="allMemberList" parameterType="MypageParam" resultType="MemberDto">
        SELECT ID, USERNAME, NICKNAME, PHONE, EMAIL, CREATE_DATE, SNS_TYPE ,AUTH
        FROM (
        SELECT ROW_NUMBER()OVER(ORDER BY USERNAME DESC) AS RNUM,
        ID, USERNAME, NICKNAME, PHONE, EMAIL, CREATE_DATE, SNS_TYPE, AUTH
        FROM MEMBER
        WHERE 1=1
        <if test="choice != null and choice != '' and search != null and search != ''">
            <if test="choice == 'id'">
                AND ID = #{search}
            </if>
            <if test="choice == 'username'">
                AND USERNAME = #{search}
            </if>
            <if test="choice == 'nickname'">
                AND NICKNAME = #{search}
            </if>
        </if>
        ORDER BY USERNAME DESC
        )
        WHERE RNUM BETWEEN #{start} AND #{end}
    </select>

    <!-- 멤버 수 -->
    <select id="memberCountSearch" parameterType="MypageParam" resultType="Integer">
        SELECT NVL(COUNT(*), 0)
        FROM MEMBER
        WHERE 1=1
        <if test="choice != null and choice != '' and search != null and search != ''">
            <if test="choice == 'id'">
                AND ID = #{search}
            </if>
            <if test="choice == 'username'">
                AND USERNAME = #{search}
            </if>
            <if test="choice == 'nickname'">
                AND NICKNAME = #{search}
            </if>
        </if>
    </select>

    <select id="memberCount" resultType="Integer">
        SELECT COUNT(*) FROM MEMBER WHERE AUTH = 0
    </select>

    <select id="getCommunity" parameterType="MypageParam" resultType="CommunityDto">
        SELECT COMMUNITY_SEQ, USER_ID, (SELECT NICKNAME FROM MEMBER WHERE ID = USER_ID) AS NICKNAME,
               TITLE, WDATE, CONTENT, READCOUNT, LIKECOUNT, DEL, BBSTYPE
        FROM (
            SELECT ROW_NUMBER()OVER(ORDER BY WDATE DESC) AS RNUM,
            COMMUNITY_SEQ, TITLE, WDATE, CONTENT, READCOUNT, LIKECOUNT, DEL, BBSTYPE, USER_ID
            FROM COMMUNITY_BBS
            WHERE 1=1
            AND DEL = 0
            AND BBSTYPE = #{bbstype}
                <if test="choice != null and choice != '' and search != null and search != ''">
                    <if test="choice == 'title'">
                        AND TITLE LIKE '%'||#{search}||'%'
                    </if>
                    <if test="choice == 'content'">
                        AND CONTENT LIKE '%'||#{search}||'%'
                    </if>
                    <if test="choice == 'writer'">
                        AND (SELECT NICKNAME FROM MEMBER WHERE ID = USER_ID) = #{search}
                    </if>
                </if>
            ORDER BY WDATE DESC
            )
        WHERE RNUM BETWEEN #{start} AND #{end}
    </select>

    <!--글의 총수 -->
    <select id="getCommunityCount" parameterType="MypageParam" resultType="Integer">
        SELECT NVL(COUNT(*), 0)
        FROM COMMUNITY_BBS
        WHERE 1=1
        AND BBSTYPE = #{bbstype}
        AND DEL = 0
        <if test="choice != null and choice != '' and search != null and search != ''">
            <if test="choice == 'title'">
                AND TITLE LIKE '%'||#{search}||'%'
            </if>
            <if test="choice == 'content'">
                AND CONTENT LIKE '%'||#{search}||'%'
            </if>
            <if test="choice == 'writer'">
                AND (SELECT NICKNAME FROM MEMBER WHERE ID = USER_ID) = #{search}
            </if>
        </if>
    </select>

    <select id="getCommunityTotalCount" resultType="int">
        SELECT COUNT(*) FROM COMMUNITY_BBS WHERE DEL=0
    </select>

    <select id="getQnaWaitTotalCount" resultType="int">
        SELECT SUM( (SELECT COUNT(*) FROM QNA WHERE STATUS = 0) + (SELECT COUNT(*) FROM PRODUCT_QNA WHERE STATUS = 0) ) AS WAIT_QNA FROM DUAL
    </select>

    <select id="regiPathCount" resultType="map">
        SELECT (SELECT count(*) FROM MEMBER WHERE AUTH = 0) AS TOTAL ,(SELECT count(*) FROM MEMBER WHERE SNS_TYPE = 'none' AND AUTH = 0) AS BITCAMPING, (SELECT count(*) FROM MEMBER WHERE SNS_TYPE = 'kakao' AND AUTH = 0) AS KAKAO, (SELECT count(*) FROM MEMBER WHERE SNS_TYPE = 'naver' AND AUTH = 0) AS NAVER FROM DUAL
    </select>

    <select id="recentCommunity" resultType="CommunityDto">

        SELECT TITLE,BBSTYPE,WDATE,COMMUNITY_SEQ,
               (SELECT NVL(COUNT(*),0)
               FROM COMMUNITY_BBS_COMMENT
               WHERE COMMUNITY_BBS.COMMUNITY_SEQ = COMMUNITY_BBS_COMMENT.COMMUNITY_SEQ
                 AND DEL = 0) AS COMMENTCOUNT
        FROM COMMUNITY_BBS
        WHERE BBSTYPE = 'find' AND DEL = 0
        <![CDATA[
            AND ROWNUM <= 7
        ]]>

        UNION

        SELECT TITLE,BBSTYPE,WDATE,COMMUNITY_SEQ,
               (SELECT NVL(COUNT(*),0)
                FROM COMMUNITY_BBS_COMMENT
                WHERE COMMUNITY_BBS.COMMUNITY_SEQ = COMMUNITY_BBS_COMMENT.COMMUNITY_SEQ
                  AND DEL = 0) AS COMMENTCOUNT
        FROM COMMUNITY_BBS
        WHERE BBSTYPE = 'free' AND DEL = 0
        <![CDATA[
            AND ROWNUM <= 7
        ]]>

        UNION

        SELECT TITLE,BBSTYPE,WDATE,COMMUNITY_SEQ,
               (SELECT NVL(COUNT(*),0)
                FROM COMMUNITY_BBS_COMMENT
                WHERE COMMUNITY_BBS.COMMUNITY_SEQ = COMMUNITY_BBS_COMMENT.COMMUNITY_SEQ
                  AND DEL = 0) AS COMMENTCOUNT
        FROM COMMUNITY_BBS
        WHERE DEL = 0
          AND (BBSTYPE = 'sell' or BBSTYPE = 'buy' or BBSTYPE = 'soldout')
        <![CDATA[
            AND ROWNUM <= 7
        ]]>

        UNION

        SELECT TITLE,BBSTYPE,WDATE,COMMUNITY_SEQ,
               (SELECT NVL(COUNT(*),0)
                FROM COMMUNITY_BBS_COMMENT
                WHERE COMMUNITY_BBS.COMMUNITY_SEQ = COMMUNITY_BBS_COMMENT.COMMUNITY_SEQ
                  AND DEL = 0) AS COMMENTCOUNT
        FROM COMMUNITY_BBS
        WHERE BBSTYPE = 'review' AND DEL = 0
        <![CDATA[
          AND ROWNUM <= 7
        ]]>
        ORDER BY BBSTYPE, WDATE DESC

    </select>


  </mapper>