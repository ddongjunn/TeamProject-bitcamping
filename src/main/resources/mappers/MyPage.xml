<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.camping.bit.dao.MypageDao">

    <select id="getMyCommunity" parameterType="MypageParam" resultType="CommunityDto">
        SELECT COMMUNITY_SEQ, TITLE, WDATE, CONTENT, READCOUNT, LIKECOUNT, DEL, BBSTYPE,
               ( SELECT MEMBER.NICKNAME FROM MEMBER WHERE MEMBER.ID = #{id} ) AS NICKNAME

        FROM (
            SELECT ROW_NUMBER()OVER(ORDER BY WDATE DESC) AS RNUM,
            COMMUNITY_SEQ, TITLE, WDATE, CONTENT, READCOUNT, LIKECOUNT, DEL, BBSTYPE
            FROM COMMUNITY_BBS
                WHERE 1=1
                    AND BBSTYPE = #{bbstype}
                    AND USER_ID = #{id}
                    AND DEL = 0
                    <if test="choice != null and choice != '' and search != null and search != ''">
                        <if test="choice == 'title'">
                             AND TITLE LIKE '%'||#{search}||'%'
                        </if>
                        <if test="choice == 'content'">
                            AND CONTENT LIKE '%'||#{search}||'%'
                        </if>
                    </if>
            ORDER BY WDATE DESC
            )
        WHERE RNUM BETWEEN #{start} AND #{end}
    </select>

    <!--글의 총수 -->
    <select id="getMyCommunityCount" parameterType="MypageParam" resultType="Integer">
        SELECT NVL(COUNT(*), 0)
        FROM COMMUNITY_BBS
        WHERE 1=1
            AND BBSTYPE = #{bbstype}
            AND USER_ID = #{id}
            AND DEL = 0
        <if test="choice != null and choice != '' and search != null and search != ''">
            <if test="choice == 'title'">
                AND TITLE LIKE '%'||#{search}||'%'
            </if>
            <if test="choice == 'content'">
                AND CONTENT LIKE '%'||#{search}||'%'
            </if>
        </if>
    </select>

    <update id="modifyInfo" parameterType="MemberDto">
        UPDATE MEMBER SET NICKNAME = #{nickname}, PHONE = #{phone},  EMAIL = #{email} WHERE ID = #{id}
    </update>

    <select id="getPassword" parameterType="String" resultType="String">
        SELECT PASSWORD FROM MEMBER WHERE ID = #{id}
    </select>

    <update id="withdrawal" parameterType="String">
        UPDATE MEMBER SET AUTH = -1 WHERE ID = #{id}
    </update>
    
    <!-- 영신 추가 -->
    <select id="getMyOrderList" parameterType="MypageParam" resultType="ProductOrderDto">
		SELECT ORDER_SEQ, USER_ID, ORDER_DATE, PRODUCT_SEQ, OPTION1_SEQ, OPTION2_SEQ, QUANTITY, 
			RENT_SEQ, RENT_SDATE, RENT_EDATE, PRODUCT_PRICE, SHIPPING_FEE, TOTAL_PRICE, 
			RECEIVER, ADDRESS, RECEIVER_PHONE, MEMO, PAYMENT, MERCHANT_UID, ORDER_STATUS, REVIEW_STATUS,
			(SELECT PRODUCT_NAME FROM PRODUCT WHERE PRODUCT_SEQ = P.PRODUCT_SEQ) AS PRODUCT_NAME,
			(SELECT THUMBNAIL_NAME FROM PRODUCT WHERE PRODUCT_SEQ = P.PRODUCT_SEQ) AS THUMBNAIL_NAME,
			(SELECT OPTION_NAME FROM PRODUCT_OPTION WHERE OPTION_SEQ = P.OPTION1_SEQ) AS OPTION1_NAME,
			(SELECT OPTION_NAME FROM PRODUCT_OPTION WHERE OPTION_SEQ = P.OPTION2_SEQ) AS OPTION2_NAME,
			(SELECT RENT_NAME FROM PRODUCT_RENT WHERE RENT_SEQ = P.RENT_SEQ) AS RENT_NAME
		FROM (
			SELECT ROW_NUMBER()OVER(ORDER BY ORDER_DATE DESC) AS RNUM,
				ORDER_SEQ, USER_ID, ORDER_DATE, PRODUCT_SEQ, OPTION1_SEQ, OPTION2_SEQ, QUANTITY, 
				RENT_SEQ, RENT_SDATE, RENT_EDATE, PRODUCT_PRICE, SHIPPING_FEE, TOTAL_PRICE, 
				RECEIVER, ADDRESS, RECEIVER_PHONE, MEMO, PAYMENT, MERCHANT_UID, ORDER_STATUS, REVIEW_STATUS
			FROM PRODUCT_ORDER
			WHERE USER_ID = #{id}
			) P	
		WHERE RNUM BETWEEN #{start} AND #{end}
		ORDER BY ORDER_DATE DESC
	</select>
	
	<select id="getMyOrderCount" parameterType="MypageParam" resultType="Integer">
        SELECT NVL(COUNT(*), 0)
        FROM PRODUCT_ORDER
        WHERE USER_ID = #{id}
    </select>

</mapper>